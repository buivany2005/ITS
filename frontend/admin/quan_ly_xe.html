<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thống kê & Báo cáo</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root {
        --primary: #137fec;
        --text: #111418;
        --muted: #617589;
      }
      body {
        font-family:
          "Inter",
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          sans-serif;
        background: #f6f8fb;
        color: var(--text);
      }
      .card {
        background: #ffffff;
        border: 1px solid #dbe0e6;
        border-radius: 16px;
        box-shadow: 0 12px 30px rgba(17, 20, 24, 0.04);
      }
    </style>
  </head>
  <body class="min-h-screen">
    <div class="flex min-h-screen">
      <!-- Sidebar -->
      <aside
        class="w-72 bg-white border-r border-[#dbe0e6] px-6 py-8 flex flex-col gap-8"
      >
        <div class="flex items-center gap-3">
          <div
            class="size-10 rounded-lg bg-[var(--primary)] text-white flex items-center justify-center font-extrabold"
          >
            <span class="material-symbols-outlined">directions_car</span>
          </div>
          <div>
            <p class="text-base font-extrabold text-[var(--text)]">
              Hệ thống Thuê Xe
            </p>
            <p class="text-xs text-[var(--muted)]">Quản trị viên hệ thống</p>
          </div>
        </div>
        <nav class="flex flex-col gap-2 text-sm font-semibold flex-1">
          <a
            href="quan_ly_phuong_tien.html"
            class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-100 text-[var(--text)]"
          >
            <span class="material-symbols-outlined">directions_car</span>
            <span>Quản lý xe</span>
          </a>
          <a
            href="quan_ly_don_hang.html"
            class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-100 text-[var(--text)]"
          >
            <span class="material-symbols-outlined">calendar_month</span>
            <span>Đơn đặt xe</span>
          </a>
          <a
            href="quan_ly_khach_hang.html"
            class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-100 text-[var(--text)]"
          >
            <span class="material-symbols-outlined">group</span>
            <span>Khách hàng</span>
          </a>
          <a
            href="quan_ly_xe.html"
            class="flex items-center gap-3 px-3 py-2 rounded-lg bg-[var(--primary)]/10 text-[var(--primary)]"
          >
            <span class="material-symbols-outlined">analytics</span>
            <span>Thống kê & Báo cáo</span>
          </a>
          <a
            href="cai_dat.html"
            class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-100 text-[var(--text)]"
          >
            <span class="material-symbols-outlined">settings</span>
            <span>Cài đặt</span>
          </a>
        </nav>

        <div class="mt-auto card p-3 flex items-center gap-3">
          <div
            class="size-10 rounded-full bg-[var(--primary)]/15 flex items-center justify-center text-[var(--primary)] font-bold"
          >
            QTV
          </div>
          <div class="flex-1">
            <p class="font-bold text-sm">Quản trị viên</p>
            <p class="text-xs text-[var(--muted)]">admin@example.com</p>
          </div>
          <button id="btn-logout" class="text-[var(--muted)]">
            <span class="material-symbols-outlined">logout</span>
          </button>
        </div>
      </aside>

      <!-- Main content -->
      <main class="flex-1 px-8 py-10">
        <header class="flex flex-col gap-2 mb-8">
          <p class="text-sm text-[var(--muted)] font-semibold">Dashboard</p>
          <div class="flex items-center justify-between">
            <div>
              <h1 class="text-3xl font-extrabold">Thống kê & Báo cáo</h1>
              <p class="text-[var(--muted)]">Tổng quan hoạt động hệ thống</p>
            </div>
            <div class="flex items-center gap-2">
              <input
                id="btn-range"
                type="date"
                class="border border-[#dbe0e6] rounded-lg px-3 py-2 text-sm"
              />
              <button
                id="btn-export-report"
                class="flex items-center gap-2 bg-[var(--primary)] text-white px-4 py-2 rounded-lg font-semibold"
              >
                <span class="material-symbols-outlined">file_download</span>
                Xuất báo cáo
              </button>
            </div>
          </div>
        </header>

        <!-- Stat cards -->
        <section
          class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-8"
        >
          <div class="card p-4 flex items-center justify-between">
            <div>
              <p class="text-xs font-semibold text-[var(--muted)]">Doanh thu</p>
              <p id="stat-total-revenue" class="text-2xl font-extrabold mt-1">
                0 ₫
              </p>
              <p class="text-[var(--muted)] text-xs">Tổng doanh thu hệ thống</p>
            </div>
            <span class="material-symbols-outlined text-[var(--primary)]"
              >payments</span
            >
          </div>
          <div class="card p-4 flex items-center justify-between">
            <div>
              <p class="text-xs font-semibold text-[var(--muted)]">
                Đơn hoàn tất
              </p>
              <p
                id="stat-completed-orders"
                class="text-2xl font-extrabold mt-1"
              >
                0
              </p>
              <p class="text-[var(--muted)] text-xs">Đã hoàn thành</p>
            </div>
            <span class="material-symbols-outlined text-green-500"
              >task_alt</span
            >
          </div>
          <div class="card p-4 flex items-center justify-between">
            <div>
              <p class="text-xs font-semibold text-[var(--muted)]">Đơn hủy</p>
              <p
                id="stat-cancelled-orders"
                class="text-2xl font-extrabold mt-1"
              >
                0
              </p>
              <p class="text-[var(--muted)] text-xs">Tỷ lệ hủy</p>
            </div>
            <span class="material-symbols-outlined text-red-500">cancel</span>
          </div>
          <div class="card p-4 flex items-center justify-between">
            <div>
              <p class="text-xs font-semibold text-[var(--muted)]">Số xe</p>
              <p id="stat-total-vehicles" class="text-2xl font-extrabold mt-1">
                0
              </p>
              <p class="text-[var(--muted)] text-xs">Tổng xe đang quản lý</p>
            </div>
            <span class="material-symbols-outlined text-amber-500">garage</span>
          </div>
        </section>

        <section class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-8">
          <!-- Monthly revenue -->
          <div class="card p-6 xl:col-span-2">
            <div class="flex items-center justify-between mb-4">
              <div>
                <h2 class="text-lg font-bold">Doanh thu 7 tháng gần nhất</h2>
                <p class="text-[var(--muted)] text-sm">
                  Dữ liệu từ đơn đã hoàn thành/đang thuê
                </p>
              </div>
            </div>
            <div class="relative h-72 flex items-end gap-4" id="revenue-bars">
              <!-- bars generated by JS -->
            </div>
          </div>

          <!-- Vehicle donut -->
          <div class="card p-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-bold">Cơ cấu đội xe</h2>
              <span class="text-[var(--muted)] text-sm">Theo loại xe</span>
            </div>
            <div class="flex items-center gap-6">
              <div
                id="vehicle-donut"
                class="relative size-44 rounded-full flex items-center justify-center"
                style="
                  background: conic-gradient(
                    #137fec 0% 33%,
                    #ff9f43 33% 66%,
                    #28c76f 66% 100%
                  );
                "
              >
                <div
                  class="size-24 rounded-full bg-white flex flex-col items-center justify-center text-center border border-[#dbe0e6]"
                >
                  <span id="donut-total" class="text-xl font-bold">0</span>
                  <span class="text-[var(--muted)] text-xs">Tổng xe</span>
                </div>
              </div>
              <div class="flex-1 space-y-3 text-sm">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <span
                      class="size-3 rounded-full bg-[var(--primary)]"
                    ></span>
                    <span>Xe máy</span>
                  </div>
                  <span id="legend-bike">0%</span>
                </div>
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <span class="size-3 rounded-full bg-[#ff9f43]"></span>
                    <span>Ô tô</span>
                  </div>
                  <span id="legend-car">0%</span>
                </div>
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <span class="size-3 rounded-full bg-[#28c76f]"></span>
                    <span>Xe đạp</span>
                  </div>
                  <span id="legend-bicycle">0%</span>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Recent orders -->
        <section class="card">
          <div
            class="flex items-center justify-between p-6 border-b border-[#dbe0e6]"
          >
            <div>
              <h2 class="text-lg font-bold">Các đơn gần đây</h2>
              <p class="text-sm text-[var(--muted)]">Danh sách mới nhất</p>
            </div>
            <button
              id="btn-view-all"
              class="text-[var(--primary)] text-sm font-semibold"
            >
              Xem tất cả
            </button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-left">
              <thead class="bg-slate-50 text-xs text-[var(--muted)] uppercase">
                <tr>
                  <th class="px-6 py-3">Khách hàng</th>
                  <th class="px-6 py-3">Loại xe</th>
                  <th class="px-6 py-3">Ngày thuê</th>
                  <th class="px-6 py-3">Thành tiền</th>
                  <th class="px-6 py-3">Trạng thái</th>
                </tr>
              </thead>
              <tbody
                id="recent-orders"
                class="divide-y divide-[#dbe0e6] text-sm"
              >
                <tr>
                  <td class="px-6 py-3 text-[var(--muted)]" colspan="5">
                    Đang tải...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </main>
    </div>

    <template id="bar-template">
      <div class="flex-1 flex flex-col items-center gap-2" data-bar>
        <div
          class="w-full bg-slate-100 rounded-lg h-48 flex items-end justify-center"
        >
          <div
            class="bar-fill w-3 rounded-lg bg-[var(--primary)]"
            style="height: 16px"
          ></div>
        </div>
        <span class="text-xs text-[var(--muted)]" data-month></span>
      </div>
    </template>

    <script>
      (function () {
        const $ = (s, r = document) => r.querySelector(s);
        const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));

        const revenueBars = $("#revenue-bars");
        const barTemplate = $("#bar-template").content.firstElementChild;
        const monthNames = [
          "T1",
          "T2",
          "T3",
          "T4",
          "T5",
          "T6",
          "T7",
          "T8",
          "T9",
          "T10",
          "T11",
          "T12",
        ];
        const monthKeys = [];

        // Build bar placeholders for last 7 months
        revenueBars.innerHTML = "";
        const now = new Date();
        for (let i = 6; i >= 0; i--) {
          const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
          const key = d.getMonth();
          monthKeys.push(key);
          const bar = barTemplate.cloneNode(true);
          bar.querySelector("[data-month]").textContent = monthNames[key];
          revenueBars.appendChild(bar);
        }

        function formatCurrency(v) {
          return v.toLocaleString("vi-VN", {
            style: "currency",
            currency: "VND",
            maximumFractionDigits: 0,
          });
        }

        function updateStat(id, value, suffix = "") {
          const el = $(id);
          if (el) el.textContent = suffix ? `${value}${suffix}` : value;
        }

        async function loadDashboardData() {
          try {
            const res = await fetch("/api/admin/dashboard");
            if (!res.ok) throw new Error("Failed to load dashboard");
            const data = await res.json();

            console.log("Dashboard data:", data);

            // API structure: { vehicles: {...}, orders: {...}, totalUsers: ... }
            const vehicleStats = data.vehicles || {};
            const orderStats = data.orders || {};

            // Get total revenue from completed orders
            const totalRevenue = await getTotalRevenue();

            updateStat("#stat-total-revenue", formatCurrency(totalRevenue));
            updateStat(
              "#stat-completed-orders",
              orderStats.completedOrders || 0,
            );
            updateStat(
              "#stat-cancelled-orders",
              orderStats.cancelledOrders || 0,
            );
            updateStat("#stat-total-vehicles", vehicleStats.totalVehicles || 0);

            updateVehicleDonut(vehicleStats);

            // Load recent orders
            await loadRecentOrders();
          } catch (err) {
            console.error("Dashboard load error:", err);
          }
        }

        async function getTotalRevenue() {
          try {
            const res = await fetch("/api/admin/orders?page=0&size=1000");
            if (!res.ok) throw new Error("Failed to load orders");
            const data = await res.json();
            const orders = data.content || [];

            // Sum totalPrice of completed orders
            return orders
              .filter((order) => order.status === "COMPLETED")
              .reduce((sum, order) => sum + (order.totalPrice || 0), 0);
          } catch (err) {
            console.error("Get revenue error:", err);
            return 0;
          }
        }

        async function loadRecentOrders() {
          try {
            const res = await fetch("/api/admin/orders?page=0&size=10");
            if (!res.ok) throw new Error("Failed to load recent orders");
            const data = await res.json();
            const orders = data.content || [];
            renderRecentOrders(orders);
          } catch (err) {
            console.error("Load recent orders error:", err);
            renderRecentOrders([]);
          }
        }

        async function loadMonthlyRevenueData() {
          try {
            const res = await fetch("/api/admin/orders?page=0&size=200");
            if (!res.ok) throw new Error("Failed to load orders");
            const data = await res.json();
            const orders = data.content || [];

            const monthlyRevenue = monthKeys.reduce(
              (acc, key) => ({ ...acc, [key]: 0 }),
              {},
            );

            orders.forEach((order) => {
              if (
                order.status === "COMPLETED" ||
                order.status === "IN_PROGRESS"
              ) {
                const d = new Date(
                  order.dateFrom || order.createdAt || Date.now(),
                );
                const m = d.getMonth();
                if (m in monthlyRevenue) {
                  monthlyRevenue[m] += order.totalPrice || 0;
                }
              }
            });

            const maxRevenue = Math.max(...Object.values(monthlyRevenue), 1);
            const maxHeight = 200;
            $$("[data-bar]").forEach((barEl, idx) => {
              const monthIndex = monthKeys[idx];
              const revenue = monthlyRevenue[monthIndex] || 0;
              const heightPx = Math.max(12, (revenue / maxRevenue) * maxHeight);
              const fill = barEl.querySelector(".bar-fill");
              if (fill) fill.style.height = `${heightPx}px`;
              barEl.title = `${monthNames[monthIndex]}: ${formatCurrency(revenue)}`;
            });
          } catch (err) {
            console.error(err);
          }
        }

        function updateVehicleDonut(stats) {
          const total = stats.totalVehicles || 0;
          const bike = stats.motorcycleCount || 0;
          const car = stats.carCount || 0;
          const bicycle = stats.bicycleCount || 0;
          const sum = bike + car + bicycle || 1;

          const bikePct = Math.round((bike / sum) * 100);
          const carPct = Math.round((car / sum) * 100);
          const bicyclePct = 100 - bikePct - carPct;

          const donut = $("#vehicle-donut");
          if (donut) {
            const endCar = carPct;
            const endBike = carPct + bikePct;
            donut.style.background = `conic-gradient(#137fec 0% ${endCar}%, #ff9f43 ${endCar}% ${endBike}%, #28c76f ${endBike}% 100%)`;
          }

          updateStat("#donut-total", total);
          updateStat("#legend-bike", `${bikePct}%`);
          updateStat("#legend-car", `${carPct}%`);
          updateStat("#legend-bicycle", `${bicyclePct}%`);
        }

        function renderRecentOrders(items) {
          const tbody = $("#recent-orders");
          if (!tbody) return;
          if (!items.length) {
            tbody.innerHTML =
              '<tr><td colspan="5" class="px-6 py-3 text-center text-[var(--muted)]">Chưa có dữ liệu</td></tr>';
            return;
          }

          tbody.innerHTML = items
            .map((item) => {
              const statusClass =
                item.status === "COMPLETED"
                  ? "bg-green-100 text-green-700"
                  : item.status === "IN_PROGRESS"
                    ? "bg-blue-100 text-blue-700"
                    : "bg-slate-100 text-slate-700";

              const dateStr = item.dateFrom
                ? new Date(item.dateFrom).toLocaleDateString("vi-VN")
                : "-";

              return `
                <tr class="hover:bg-slate-50">
                  <td class="px-6 py-3">${item.customerName || "Khách"}</td>
                  <td class="px-6 py-3">${item.vehicleName || "-"}</td>
                  <td class="px-6 py-3 text-[var(--muted)]">${dateStr}</td>
                  <td class="px-6 py-3 font-semibold">${formatCurrency(item.totalPrice || 0)}</td>
                  <td class="px-6 py-3">
                    <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusClass}">${item.status || "-"}</span>
                  </td>
                </tr>`;
            })
            .join("");
        }

        async function init() {
          await loadDashboardData();
          await loadMonthlyRevenueData();
        }

        document.addEventListener("DOMContentLoaded", init);

        $("#btn-logout")?.addEventListener("click", () => {
          window.location.href = "/login/login.html";
        });

        $("#btn-export-report")?.addEventListener("click", () => {
          window.location.href = "/api/admin/orders/export";
        });

        $("#btn-view-all")?.addEventListener("click", () => {
          window.location.href = "/admin/quan_ly_don_hang.html";
        });
      })();
    </script>
  </body>
</html>
